{% extends 'base.html' %}

{% block title %}Browse Books{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6">
    
    {% if is_superuser %}
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Manage Libraries</h1>
        <p class="text-gray-600 mb-8">Select a Centre to view its collections.</p>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for centre in centres %}
            <div onclick="openCentreModal('{{ centre.id }}')" 
               class="cursor-pointer bg-white p-6 rounded-xl shadow-md hover:shadow-xl hover:-translate-y-1 transition duration-300 border-l-4 border-blue-600">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">{{ centre.name }}</h3>
                        <p class="text-sm text-gray-500 mt-1">{{ centre.centre_code }}</p>
                    </div>
                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                        {{ centre.school_count }} Schools
                    </span>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
                    <span class="text-gray-600 text-sm">Total Books</span>
                    <span class="font-bold text-gray-800">{{ centre.book_count }}</span>
                </div>
            </div>
            {% empty %}
            <p class="text-gray-500">No centres found.</p>
            {% endfor %}
        </div>

    {% else %}
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Library Categories</h1>
                <p class="text-gray-500 mt-1">Browsing collection for <span class="text-blue-600 font-semibold">{{ centre_name }}</span></p>
            </div>
        </div>

        {% if schools %}
            {% for school in schools %}
            <div class="mb-10 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <span class="w-2 h-8 bg-blue-500 rounded-full mr-3"></span>
                    {{ school.name }}
                </h2>
                
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                    {% for cat in categories %}
                        {% if cat.school_id == school.id %}
                        <a href="{% url 'grade_subject_view' cat.id %}" 
                           class="block group bg-gradient-to-br from-white to-gray-50 border border-gray-200 p-6 rounded-xl shadow-sm hover:shadow-lg hover:border-blue-300 transition duration-300 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition">
                                <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"/></svg>
                            </div>
                            <div class="text-xl font-bold text-gray-800 group-hover:text-blue-600 mb-2 relative z-10">{{ cat.name }}</div>
                            <div class="text-sm text-gray-500 font-medium relative z-10">{{ cat.num_books }} items</div>
                        </a>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-20 bg-white rounded-lg shadow">
                <p class="text-xl text-gray-500">No categories found for your school/centre.</p>
            </div>
        {% endif %}

    {% endif %}
</div>

<div id="centreModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeModal()"></div>

    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div class="relative inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div id="modalLoader" class="text-center py-10 hidden">
                    <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-gray-600">Loading library data...</p>
                </div>
                
                <div id="modalContent"></div>
            </div>
        </div>
    </div>
</div>

<script>
    function openCentreModal(centreId) {
        const modal = document.getElementById('centreModal');
        const content = document.getElementById('modalContent');
        const loader = document.getElementById('modalLoader');

        // Show modal
        modal.classList.remove('hidden');
        
        // Show loader, hide old content
        loader.classList.remove('hidden');
        content.innerHTML = '';

        // Fetch data
        fetch(`{% url 'ajax_get_centre_content' %}?centre_id=${centreId}`)
            .then(response => response.json())
            .then(data => {
                loader.classList.add('hidden');
                if (data.html) {
                    content.innerHTML = data.html;
                } else {
                    content.innerHTML = '<p class="text-red-500 text-center">Error loading data.</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                loader.classList.add('hidden');
                content.innerHTML = '<p class="text-red-500 text-center">Something went wrong.</p>';
            });
    }

    function closeModal() {
        document.getElementById('centreModal').classList.add('hidden');
    }

    // Close on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            closeModal();
        }
    });
</script>
{% endblock %}