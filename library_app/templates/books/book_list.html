{% extends 'base.html' %}

{% block title %}Books - LibraryHub{% endblock %}

{% block content %}
<div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    {% if messages %}
        <div class="fixed top-4 right-4 z-50 space-y-2 max-w-[90%] sm:max-w-md">
            {% for message in messages %}
                <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-lg shadow-lg" role="alert">
                    <p class="text-sm font-medium">{{ message|safe }}</p>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="mb-4">
        {% if category.name|lower == 'textbook' %}
        <a href="{% url 'grade_subject_view' category.id %}" class="text-gray-500 hover:text-gray-700">&larr; Back to Selection</a>
        {% else %}
        <a href="{% url 'book_list' %}" class="text-gray-500 hover:text-gray-700">&larr; Back to Categories</a>
        {% endif %}
    </div>

    <div class="mb-6 sm:mb-8 flex flex-col md:flex-row md:items-center justify-between">
        <div>
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold text-primary">
                {{ category.name }} Books
            </h1>
            <p class="text-gray-600 mt-1">Found {{ total_count }} books</p>
        </div>
        
        {% if request.user.is_superuser or request.user.is_librarian %}
        <div class="mt-4 md:mt-0">
            <a href="{% url 'book_add' %}" class="inline-flex items-center bg-secondary text-white py-2 px-4 rounded-lg hover:bg-accent transition-all font-medium shadow-sm">
                + Add Book
            </a>
        </div>
        {% endif %}
    </div>

    <div class="bg-white p-4 sm:p-6 md:p-8 rounded-xl shadow-xl border border-gray-100">
        
        <form method="get" id="filter-form" class="flex flex-col gap-4 mb-4 sm:mb-6">
            <div class="flex-1 relative">
                <input type="text" name="q" value="{{ query }}" placeholder="Search..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C86450]">
            </div>
            
            <div class="flex flex-col sm:flex-row sm:flex-wrap items-center gap-3 sm:gap-4">
                {% if category.name|lower == 'textbook' %}
                <select name="grade" onchange="this.form.submit()" class="w-full sm:w-auto px-3 py-2 border rounded-lg">
                    <option value="all">All Grades</option>
                    {% for g in grades %}
                        <option value="{{ g.id }}" {% if selected_grade == g.id|stringformat:"s" %}selected{% endif %}>{{ g.name }}</option>
                    {% endfor %}
                </select>

                <select name="subject" onchange="this.form.submit()" class="w-full sm:w-auto px-3 py-2 border rounded-lg">
                    <option value="all">All Subjects</option>
                    {% for s in subjects %}
                        <option value="{{ s.id }}" {% if selected_subject == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
                    {% endfor %}
                </select>
                {% endif %}
                
                <label class="flex items-center space-x-2">
                    <input type="checkbox" name="available" onchange="this.form.submit()" {% if request.GET.available %}checked{% endif %} class="form-checkbox text-[#C86450]">
                    <span class="text-gray-600 text-sm">Available only</span>
                </label>
                
                <button type="submit" class="w-full sm:w-auto ml-auto bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300">
                    Search
                </button>
            </div>
        </form>

        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500 table-auto">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th class="px-4 py-3">Title</th>
                        <th class="px-4 py-3 hidden md:table-cell">Author</th>
                        <th class="px-4 py-3 hidden xl:table-cell">Code</th>
                        {% if category.name|lower == 'textbook' %}
                        <th class="px-4 py-3">Grade</th>
                        <th class="px-4 py-3">Subject</th>
                        {% endif %}
                        <th class="px-4 py-3">Status</th>
                        <th class="px-4 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for book in books %}
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium text-gray-900">
                            <a href="{% url 'book_detail' book.pk %}" class="hover:underline">{{ book.title }}</a>
                        </td>
                        <td class="px-4 py-3 hidden md:table-cell">{{ book.author }}</td>
                        <td class="px-4 py-3 hidden xl:table-cell">{{ book.book_code }}</td>
                        {% if category.name|lower == 'textbook' %}
                        <td class="px-4 py-3">{{ book.grade.name|default:"-" }}</td>
                        <td class="px-4 py-3">{{ book.subject.name|default:"-" }}</td>
                        {% endif %}
                        <td class="px-4 py-3">
                            {% if book.available_copies %}
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">Available</span>
                            {% else %}
                                <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs">Out</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 flex gap-2">
                            <a href="{% url 'book_detail' book.pk %}" class="text-blue-600 hover:underline">View</a>
                            {% if request.user.is_superuser or request.user.is_librarian %}
                            <a href="{% url 'book_update' book.pk %}" class="text-green-600 hover:underline">Edit</a>
                            <a href="{% url 'book_delete' book.pk %}" class="text-red-600 hover:underline">Delete</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-4 py-3 text-center text-gray-600">No books found matching criteria.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if page_obj.has_previous or page_obj.has_next %}
        <div class="mt-4 flex justify-between items-center">
            <span class="text-sm text-gray-600">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            <div class="flex gap-2">
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if selected_grade %}&grade={{ selected_grade }}{% endif %}{% if selected_subject %}&subject={{ selected_subject }}{% endif %}" class="px-3 py-1 bg-gray-200 rounded">Prev</a>
                {% endif %}
                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if selected_grade %}&grade={{ selected_grade }}{% endif %}{% if selected_subject %}&subject={{ selected_subject }}{% endif %}" class="px-3 py-1 bg-gray-200 rounded">Next</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}